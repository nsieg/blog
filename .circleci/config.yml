# Use the latest 2.1 version of CircleCI pipeline process engine. 
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  node: circleci/node@4.1

jobs:
  
  build-and-test:  
    docker:
      - image: cimg/node:lts
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Build
          command: npm run build
      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: /home/circleci/project
          # Must be relative path from root
          paths:
            - dist

  deploy-prod:
        docker:
          - image: cimg/base:stable
        steps:
          - attach_workspace:
              at: /home/circleci/project
          - run: sudo apt-get update && sudo apt-get install -y lftp
          - run: cd dist && lftp -c "set ftp:ssl-allow no; open -u $FTP_USERNAME_PROD,$FTP_PASSWORD_PROD $FTP_HOST_PROD; mirror -Rev . / --ignore-time --parallel=10"

workflows:
  sample: 
    jobs:
      - build-and-test
      - deploy-prod:
          requires:
            - build-and-test
          filters:
            branches:
              only: master
